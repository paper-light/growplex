---
import { pb } from "../../../shared/lib/pb";
import Embed from "../../../chat/ui/widgets/Embed.svelte";
import Root from "../../../shared/ui/layouts/Root.astro";

const { chatId } = Astro.params;

if (!chatId) throw new Error("Chat ID is required");
const initTheme = Astro.url.searchParams.get("theme");
const initOpen = Astro.url.searchParams.get("open") === "true";

const chat = await pb.collection("chats").getOne(chatId, {
  expand: "integration,integration.agents",
});
const agent = (chat.expand as any)?.integration.expand.agents[0];

if (!chat || !agent) {
  throw new Error("Integration not properly configured");
}

if (!chat.domain) throw new Error("Chat domain not configured");
---

<Root title={chat.name || "Chat"} needCookies={false} loadTheme={false}>
  <Embed
    chat={chat}
    agent={agent}
    client:only
    initTheme={initTheme}
    initOpen={initOpen}
  />
</Root>

<style>
  html,
  body {
    background-color: transparent;
  }
</style>
