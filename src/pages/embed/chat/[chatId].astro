---
import { pb } from "../../../shared/lib/pb";
import Chat from "../../../chat/ui/widgets/Chat.svelte";
import Root from "../../../shared/ui/layouts/Root.astro";

const { chatId } = Astro.params;
const token = Astro.url.searchParams.get("token");

if (!token) throw new Error("Token is required");
if (!chatId) throw new Error("Chat ID is required");

const theme = Astro.url.searchParams.get("theme") || "light";

const chat = await pb.collection("chats").getOne(chatId, {
  expand: "integration,integration.agents",
});
const agent = (chat.expand as any)?.integration.expand.agents[0];

if (!chat || !agent) {
  throw new Error("Integration not properly configured");
}

if (!chat.domain) throw new Error("Chat domain not configured");
---

<Root title={chat.name || "Chat"} needCookies={false} loadTheme={false}>
  <Chat chat={chat} agent={agent} token={token} initTheme={theme} client:only />
</Root>

<style>
  html,
  body {
    background-color: transparent;
    height: 100vh;
    width: 100vw;
  }
</style>
